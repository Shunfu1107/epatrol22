@{
	ViewBag.Title = "Report";
}

@section Styles {
	@* <link rel="stylesheet" href="~/Assets/Plugins/datatables.net-bs/css/dataTables.bootstrap.min.css"> *@
}

@section scripts {
	<script src="~/Assets/Plugins/datatables.net/js/jquery.dataTables.min.js"></script>
	<script src="~/Assets/Plugins/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
	<script>
		let table;

		$(document).ready(function () {
			$('#report-table').DataTable({
				responsive: true
			});

			flatpickr("#dateRange", {
				mode: "range",
				dateFormat: "d M, Y"
			});

				$('#searchBtn').on('click', function () {
					const type = $('#type').val();
					const routeId = $('#route').val();
					const checkPointName = $('#checkPoint').val();
					const dateRange = $('#dateRange').val();
					const startTime = $('#startTime').val();
					const endTime = $('#endTime').val();

					// Highlight missing fields
					if (!type) $('#type').css('border', '1px solid red');
					if (!routeId) $('#route').css('border', '1px solid red');
					if (!checkPointName) $('#checkPoint').css('border', '1px solid red');
					if (!dateRange) $('#dateRange').css('border', '1px solid red');
					if (!startTime) $('#startTime').css('border', '1px solid red');
					if (!endTime) $('#endTime').css('border', '1px solid red');

					// Check if all required fields are filled
					if (!type || !routeId || !checkPointName || !dateRange || !startTime || !endTime) {
						alert('Please fill in all required fields!');
						return; // Stop further execution if any field is missing
					}

					console.log(type, routeId, checkPointName, dateRange, startTime, endTime);
					$.ajax({
						url: '/Report/ReportTable',
						type: 'GET',
						data: {
							type: type,
							routeId: routeId,
							checkPointName: checkPointName,
							dateRange: dateRange,
							startTime: startTime,
							endTime: endTime
						},
						success: function (data) {
							console.log(data);

							const autoTable = (type === "2");
							initializeDataTable(autoTable);

							table.clear();

							$.each(data, function (index, item) {
								const row = [
									index + 1,
									item.routeName,
									item.checkPointName,
									item.date,
									item.time,
									item.checkList,
									item.status,
									item.patrolTypeId === 1 ? "Manual" : "Auto",
									item.emergency,
									item.guard
								];

								if (autoTable) {
									row.push(item.link ? `<button class="play-video" data-video-url="${item.link}">Play Video</button>` : '');
								}

								table.row.add(row);
							});


							table.columns.adjust().draw();
						},
						error: function (xhr, status, error) {
							console.error('Error fetching data:', error);
							alert('Please select all required fields!');
							location.reload();
						}
					});
				});

				// Remove highlight on input
				$('#type, #route, #checkPoint, #dateRange, #startTime, #endTime').on('input change', function () {
					$(this).css('border', '');
				});

			$('#CSVBtn').on('click', function () {
				var csv = [];
				$('#report-table tr').each(function () {
					var row = [];
					$(this).find('td, th').each(function (index) {
						if (index < 10) {
							row.push($(this).text());
						}
					});
					csv.push(row.join(','));
				});

				var csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
				var downloadLink = document.createElement('a');
				downloadLink.download = 'Report.csv';
				downloadLink.href = window.URL.createObjectURL(csvFile);
				downloadLink.style.display = 'none';
				document.body.appendChild(downloadLink);
				downloadLink.click();
				document.body.removeChild(downloadLink);
			});

			$('#PDFBtn').on('click', function () {
				const { jsPDF } = window.jspdf;
				var doc = new jsPDF();

				var rowData = [];
				$('#report-table tr').each(function () {
					var row = [];
					$(this).find('td, th').each(function (index) {
						if (index < 10) {
							row.push($(this).text());
						}
					});
					rowData.push(row);
				});

				doc.autoTable({
					head: [rowData[0]],
					body: rowData.slice(1)
				});

				doc.save('Report.pdf');
			});
		});

		function initializeDataTable(autoTable) {
			if ($.fn.DataTable.isDataTable('#report-table')) {
				$('#report-table').DataTable().clear().destroy();
				$('#report-table tbody').empty();
			}

			let headerHtml = `
				<tr>
					<th>No.</th>
					<th>Route</th>
					<th>Checkpoint</th>
					<th>Date</th>
					<th>Time</th>
					<th>Checklist</th>
					<th>Result</th>
					<th>Type</th>
					<th>Emergency Information</th>
					<th>Guard</th>
					${autoTable ? '<th>Link</th>' : ''}
				</tr>
			`;
			$('#report-table thead').html(headerHtml);

			const columnDefinitions = [
				{ title: "No." },
				{ title: "Route" },
				{ title: "Checkpoint" },
				{ title: "Date" },
				{ title: "Time" },
				{ title: "Checklist" },
				{ title: "Result" },
				{ title: "Type" },
				{ title: "Emergency Information" },
				{ title: "Guard" }
			];

			if (autoTable) {
				columnDefinitions.push({ title: "Link" });
			}

			table = $('#report-table').DataTable({
				responsive: true,
				columns: columnDefinitions
			});
		}
	</script>
}

<!DOCTYPE html>
<html>
<head>
	<title>Report</title>
	<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
	<!--Font Style-->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:ital@1&display=swap">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
	<!--CSS Style-->
	<link rel="stylesheet" href="/css/site.css" />
</head>
<body>
	<div class="container-fluid">
		<div>
			<h4>Reports</h4>
			<hr />
			<div class="form-group">
				<div class="row">
					<div class="col-md-4">
						<label>Report Type</label>
						<select class="form-control" id="type" name="Type">
							<option value="1">Manual</option>
							<option value="2">Auto</option>
						</select>
					</div>
					<div class="col-md-4">
						<label>&nbsp;</label>
						<select class="form-control" id="route" name="Route">
							<option value="">Select Route</option>
							@foreach (var route in ViewBag.Routes)
							{
								<option value="@route.RouteId">@route.RouteName</option>
							}
						</select>
					</div>
					<div class="col-md-4">
						<label>&nbsp;</label>
						<select class="form-control" id="checkPoint" name="CheckPoint">
							<option value="">Select Checkpoint</option>
							@foreach (var checkpoint in ViewBag.CheckPoints)
							{
								<option value="@checkpoint.CheckPointName">@checkpoint.CheckPointName</option>
							}
						</select>
					</div>
					<div class="col-md-4">
						<label>&nbsp;</label>
						<input type="text" class="form-control" id="dateRange" name="dateRange" style="background-color: white;" placeholder="Select Date Range" readonly>
					</div>
					<div class="col-md-4">
						<label>&nbsp;</label>
						<input type="time" class="form-control" id="startTime" name="startTime">
					</div>
					<div class="col-md-4">
						<label>&nbsp;</label>
						<input type="time" class="form-control" id="endTime" name="endTime">
					</div>
				</div>
			</div>
			<div>
				<button class="btn btn-primary" id="searchBtn">
					Search
				</button>
			</div>
		</div>
	</div>
	<br />
	<div class="container-fluid">
		<h4>Report Results</h4>
		<hr />
		<div>
			<button class="btn btn-primary" id="CSVBtn">
				CSV
			</button>
			<button class="btn btn-primary" id="PDFBtn">
				PDF
			</button>
			<button class="btn btn-primary" id="videoBtn">
				Video
			</button>
		</div>
		<br />
		<div class="table-responsive">
			<table id="report-table" class="table table-striped table-bordered">
				<thead>
					<tr>
						<th><input type="checkbox" class="styled-checkbox">No.</th>
						<th>Route</th>
						<th>Checkpoint</th>
						<th>Date</th>
						<th>Time</th>
						<th>Checklist</th>
						<th>Result</th>
						<th>Type</th>
						<th>Emergency Information</th>
						<th>Guard</th>
						<th id="link-header">Link</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
	</div>

	<!-- Modal (Hidden by default) -->
	<div id="videoModal">
		<div class="modal-content">
			<div class="modal-header">
				<!-- Close Button -->
				<button id="closeModalBtn" class="close-modal-btn">Close</button>
			</div>
			<div class="modal-body">
				<video id="videoPlayer" controls class="video-player">
					<!-- Video source will be inserted dynamically -->
				</video>
			</div>
		</div>
	</div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script>
		$(document).ready(function() {

			// Play Video Button Click Event
			// $(document).on('click', '.play-video', function () {
			//     var videoUrl = $(this).data('video-url'); // Get the video URL from the button's data attribute

			//     // Check if the video URL is valid
			//     if (videoUrl) {
			//         // Get the video player element
			//         var videoPlayer = document.getElementById("videoPlayer");

			//         // Set the video URL as the source
			//         videoPlayer.src = videoUrl;

			//         // Show the modal by changing the display style
			//         var modal = document.getElementById("videoModal");
			//         modal.style.display = "flex";  // Make sure the modal is visible
			//     } else {
			//         alert('Video URL is not valid.');
			//     }
			// });

			// Play Video Button Click Event
			$(document).on('click', '.play-video', function () {
				var videoUrl = $(this).data('video-url'); // Get the video URL (Base64 string)

				if (videoUrl) {
					var videoPlayer = document.getElementById("videoPlayer");
					videoPlayer.src = videoUrl; // Set Base64 string as the video source

					var modal = document.getElementById("videoModal");
					modal.style.display = "flex"; // Show the modal
				} else {
					alert('Video URL is invalid.');
				}
			});


			// Close Modal Function
			function closeModal() {
				// Hide the modal
				var modal = document.getElementById("videoModal");
				modal.style.display = "none";

				// Stop the video when closing the modal
				var videoPlayer = document.getElementById("videoPlayer");
				videoPlayer.pause();
				videoPlayer.currentTime = 0;

				// Clear the video source to stop the video
				videoPlayer.src = '';
			}

			// Attach the closeModal function to the close button
			$(document).on('click', '#closeModalBtn', function() {
				closeModal();
			});
		});
	</script>

	<script>

		$(document).ready(function() {
			// Hardcode the video URL for testing
			const videoUrl = "video_saved/20250121_021356_output_video.avi";

			// Play Video Button (videoBtn) Click Event
			$('#videoBtn').on('click', function() {
				// Get the video player element
				var videoPlayer = document.getElementById("videoPlayer");

				// Set the video URL as the source
				videoPlayer.src = videoUrl;

				// Show the modal by changing the display style
				var modal = document.getElementById("videoModal");
				modal.style.display = "flex";  // Make sure the modal is visible
			});

			// Close Modal Function
			function closeModal() {
				// Hide the modal
				var modal = document.getElementById("videoModal");
				modal.style.display = "none";

				// Stop the video when closing the modal
				var videoPlayer = document.getElementById("videoPlayer");
				videoPlayer.pause();
				videoPlayer.currentTime = 0;
			}

			// Attach the closeModal function to the close button (optional)
			$(document).on('click', '#closeModalBtn', function() {
				closeModal();
			});
		});
	</script>

</body>
</html>