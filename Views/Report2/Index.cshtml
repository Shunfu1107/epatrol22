@{
	ViewBag.Title = "Report 2";
}

<!DOCTYPE html>
<html>
<head>
	<title>Report</title>
	<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
	<!-- PDF -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
	<!-- DataTables library loaded before jQuery library -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="~/Assets/Plugins/extended-user-identity/mel.addon.module.js"></script>
	<script src="~/Assets/Plugins/datatables.net/js/jquery.dataTables.min.js"></script>
	<script src="~/Assets/Plugins/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
@* 	<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script> *@
	
	<!--Font Style-->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:ital@1&display=swap">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
	<!--CSS Style-->
	<link rel="stylesheet" href="/css/site.css" />

</head>

<body>
	<div class="container-fluid" style="width: 100%; margin: auto; border-radius: 10px; background-color: white; padding: 20px;">
		<div>
			<h4>Reports</h4>
			<hr />
			<div class="form-group">
				<div class="row">
					<div class="col-md-4">
						<label>Report Type</label>
						<select class="form-control" id="type" name="Type" style="border-radius: 5px; padding-left: 10px; padding-right: 10px;">
							<option value="1">Manual</option>
							<option value="2">Auto</option>
						</select>
					</div>
					<div class="col-md-4">
						<label>&nbsp;</label>
						<select class="form-control" id="route" name="Route" style="border-radius: 5px; padding-left: 10px; padding-right: 10px;">
							<option value="">Select Route</option>
						</select>
					</div>
					<div class="col-md-4">
						<label>&nbsp;</label>
						<select class="form-control" id="checkPoint" name="CheckPoint" style="border-radius: 5px; padding-left: 10px; padding-right: 10px;">
							<option value="">Select Checkpoint</option>
						</select>
					</div>
					<div class="col-md-4">
						<label>&nbsp;</label>
						<input type="text" class="form-control" id="dateRange" name="dateRange" style="border-radius: 5px; padding-left: 10px; padding-right: 10px; background-color: white;" placeholder="Select Date Range" readonly>
					</div>
					<div class="col-md-4">
						<label>&nbsp;</label>
						<input type="time" class="form-control" id="startTime" name="startTime" style="border-radius: 5px; padding-left: 10px; padding-right: 10px; background-color: white;">
					</div>
					<div class="col-md-4">
						<label>&nbsp;</label>
						<input type="time" class="form-control" id="endTime" name="endTime" style="border-radius: 5px; padding-left: 10px; padding-right: 10px; background-color: white;">
					</div>
				</div>
			</div>
			<div>
				<button class="btn btn-primary" id="searchBtn"
						style="padding: 8px 30px; border: none; border-radius: 5px; cursor: pointer; margin-right:5px;">
					Search
				</button>
			</div>
		</div>
	</div>

	</br>
	</br>

	<div class="container-fluid">
		<h4>Report Results</h4>
		<hr />
		<div>
			<button class="btn btn-primary" id="CSVBtn">
				CSV
			</button>
			<button class="btn btn-primary" id="PDFBtn">
				PDF
			</button>
		</div>
		<br />
		<div class="table-responsive">
			<table id="patrol-table" class="table table-striped table-bordered">
				<thead>
					<tr>
						<th><input type="checkbox" class="styled-checkbox">No.</th>
						<th>Route</th>
						<th>Checkpoint</th>
						<th>Date</th>
						<th>Time</th>
						<th>Checklist</th>
						<th>Result</th>
						<th>Type</th>
						<th>Emergency Information</th>
						<th>Guard</th>
						<th id="link-header">Link</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
	</div>

	<!-- Modal (Hidden by default) -->
	<div id="videoModal">
		<div class="modal-content">
			<div class="modal-header">
				<!-- Close Button -->
				<button id="closeModalBtn" class="close-modal-btn">Close</button>
			</div>
			<div class="modal-body">
				<video id="videoPlayer" controls class="video-player">
					<!-- Video source will be inserted dynamically -->
				</video>
			</div>
		</div>
	</div>

	@* Initialize for datatable *@
	@section scripts {
		<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
		<script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap4.min.js"></script>
		<script src="~/Assets/Plugins/datatables.net/js/jquery.dataTables.min.js"></script>
		<script src="~/Assets/Plugins/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
		<script>
			$(document).ready(function() {
				$("#patrol-table").DataTable();
			});
			
		</script>
	}

	<script>
		$(document).ready(function() {
            flatpickr("#dateRange", {
				mode: "range",
				dateFormat: "d M, Y"
			});
			
			toggleRouteSelection();

			// Trigger toggle when report type changes
			$("#type").on("change", function () {
				toggleRouteSelection();
			});

			function toggleRouteSelection() {
				const reportType = $("#type").val();

				if (reportType == "1" || reportType == "2") { // Manual
					$("#route").closest('.col-md-4').show(); // Show the Route dropdown
					getRoutes(reportType); // Fetch routes only for Manual
				} else {
					$("#route").closest('.col-md-4').hide(); // Hide the Route dropdown
					$("#route").empty().append('<option value="">Select Route</option>'); // Reset the dropdown
				}
			}
			
			function getRoutes(reportType) {
				$.ajax({
					url: '@Url.Action("GetRoutes", "Report2")',
					type: 'GET',
					data: { reportType: reportType }, // Send report type to filter routes
					success: function(response) {
						$("#route").empty(); // Clear existing options
						$("#route").append('<option value="">Select Route</option>');

						$.each(response, function(index, route) {
							$("#route").append('<option value="' + route.routeId + '">' + route.routeName + '</option>');
						});
					},
					error: function(xhr, status, error) {
						console.error("Error fetching routes: ", error);
					}
				});
			}
		
			//Fetch CheckPoints data
			$("#route").on("change", function () {
				var selectedRouteId = $(this).val();

				if (selectedRouteId) {
					getCheckpoints(selectedRouteId);
				} else {
					$("#checkPoint").empty();
					$("#checkPoint").append('<option value="">Select Checkpoint</option>');
				}
			});

			function getCheckpoints(routeId) {
				$.ajax({
					url: '@Url.Action("GetCheckpoints", "Report2")',
					type: 'GET',
					data: { routeId: routeId }, // Send selected Route ID
					success: function (response) {
						$("#checkPoint").empty();
						$("#checkPoint").append('<option value="">Select Checkpoint</option>');

						$.each(response, function (index, checkpoint) {
							$("#checkPoint").append('<option value="' + checkpoint.checkPointId + '">' + checkpoint.checkPointName + '</option>');
						});
					},
					error: function (xhr, status, error) {
						console.error("Error fetching checkpoints: ", error);
					}
				});
			}

			$('#searchBtn').on('click', function () {
				const type = $('#type').val();
				const routeId = $('#route').val();
				//const checkPointName = $('#checkPoint').val();
				const checkPointName =  $('#checkPoint option:selected').text();		 
				const dateRange = $('#dateRange').val();
				const startTime = $('#startTime').val();
				const endTime = $('#endTime').val();

				// Highlight missing fields
				if (!type) $('#type').css('border', '1px solid red');
				if (!routeId) $('#route').css('border', '1px solid red');
				if (!checkPointName) $('#checkPoint').css('border', '1px solid red');
				if (!dateRange) $('#dateRange').css('border', '1px solid red');
				if (!startTime) $('#startTime').css('border', '1px solid red');
				if (!endTime) $('#endTime').css('border', '1px solid red');

				// Check if all required fields are filled
				if (!type || !routeId || !checkPointName || !dateRange || !startTime || !endTime) {
					alert('Please fill in all required fields!');
					return; // Stop further execution if any field is missing
				}

				//console.log(type, routeId, checkPointName, dateRange, startTime, endTime);

				//Render the Patrol Data to frontend
				bindDatatable(type, routeId, checkPointName, dateRange, startTime, endTime);
			});

			$('#CSVBtn').on('click', function () {
				var csv = [];
				$('#patrol-table tr').each(function () {
					var row = [];
					$(this).find('td, th').each(function (index) {
						if (index < 10) {
							row.push($(this).text());
						}
					});
					csv.push(row.join(','));
				});

				var csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
				var downloadLink = document.createElement('a');
				downloadLink.download = 'Report.csv';
				downloadLink.href = window.URL.createObjectURL(csvFile);
				downloadLink.style.display = 'none';
				document.body.appendChild(downloadLink);
				downloadLink.click();
				document.body.removeChild(downloadLink);
			});

			$('#PDFBtn').on('click', function () {
				const { jsPDF } = window.jspdf;
				var doc = new jsPDF();

				var rowData = [];
				$('#patrol-table tr').each(function () {
					var row = [];
					$(this).find('td, th').each(function (index) {
						if (index < 10) {
							row.push($(this).text());
						}
					});
					rowData.push(row);
				});

				doc.autoTable({
					head: [rowData[0]],
					body: rowData.slice(1)
				});

				doc.save('Report.pdf');
			});

			// Play Video Button Click Event
			$(document).on('click', '.play-video', function () {
				var videoUrl = $(this).data('video-url'); // Get the video URL (Base64 string)

				if (videoUrl) {
					var videoPlayer = document.getElementById("videoPlayer");
					videoPlayer.src = videoUrl; // Set Base64 string as the video source

					var modal = document.getElementById("videoModal");
					modal.style.display = "flex"; // Show the modal
				} else {
					alert('Video URL is invalid.');
				}
			});


			// Close Modal Function
			function closeModal() {
				// Hide the modal
				var modal = document.getElementById("videoModal");
				modal.style.display = "none";

				// Stop the video when closing the modal
				var videoPlayer = document.getElementById("videoPlayer");
				videoPlayer.pause();
				videoPlayer.currentTime = 0;

				// Clear the video source to stop the video
				videoPlayer.src = '';
			}

			// Attach the closeModal function to the close button
			$(document).on('click', '#closeModalBtn', function() {
				closeModal();
			});

			function bindDatatable(type, routeId, checkPointName, dateRange, startTime, endTime) {
				var tableElement = $('#patrol-table');

				if (tableElement.length > 0) {
					if ($.fn.dataTable.isDataTable(tableElement)) {
						tableElement.DataTable().destroy();
						tableElement.empty();
					}
				}

					// Define columns for DataTable
				var columns = [
					{
						"data": null,
						"title": "No.",
						"render": function (data, type, row, meta) {
							return meta.row + meta.settings._iDisplayStart + 1;
						},
						"orderable": false
					},
					{
						"data": "routeName",
						"title": "Route Name"
					},
					{
						"data": "checkPointName",
						"title": "Checkpoint Name"
					},
					{
						"data": "date",
						"title": "Date",
						"render": function(data) {
							return data;
						}
					},
					{
						"data": "time",
						"title": "Time",
						"render": function(data) {
							return data;
						}
					},
					{
						"data": "checkListName",
						"title": "Checklist Name"
					},
					{
						"data": "status",
						"title": "Status"
					},
					{
						"data": "type",
						"title": "Type"
					},
					{
						"data": "emergencyInformation",
						"title": "Emergency Information"
					},
					{
						"data": "guard",
						"title": "Guard"
					}
				];

				// Add the "Link" column only if the type is NOT "Manual" (type != 1)
				if (type != 1) {
					columns.push({
						"data": "link",
						"title": "Link",
						"render": function(data, type, row) {
							return data ? `<button class="play-video" data-video-url="${data}">Play Video</button>` : '';
						}
					});
				}

				tableElement.DataTable({
					"processing": false,
					"serverSide": false,
					"searching": true,
					"paging": true,
					"ajax": {
						"url": "/Report2/GetPatrolData",
						"type": "GET",
						"data": {
							type: type,
							routeId: routeId,
							checkPointName: checkPointName,
							dateRange: dateRange,
							startTime: startTime,
							endTime: endTime
						},
						"dataSrc": function (json) {
							if (!json.data || json.data.length === 0) {
								alert("No data found.");
									return [];
							}
								return json.data;
							},
							"error": function (xhr, status, error) {
								console.error("Error:", error);
								alert("An error occurred while fetching data.");
							}					},
					"columns": columns
				});
			}
		});

	</script>
</body>


</html>
